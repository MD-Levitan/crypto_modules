#include <stdio.h>
#include <errno.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>
#include <sys/socket.h>
#include <linux/if_alg.h>

static uint8_t test_key[32] = {
	0xe9, 0xde, 0xe7, 0x2c, 0x8f, 0x0c, 0x0f, 0xa6,
	0x2d, 0xdb, 0x49, 0xf4, 0x6f, 0x73, 0x96, 0x47,
	0x06, 0x07, 0x53, 0x16, 0xed, 0x24, 0x7a, 0x37,
	0x39, 0xcb, 0xa3, 0x83, 0x03, 0xa9, 0x8b, 0xf6
};

static uint8_t test_pt[48] = {
	0xb1, 0x94, 0xba, 0xc8, 0x0a, 0x08, 0xf5, 0x3b,
	0x36, 0x6d, 0x00, 0x8e, 0x58, 0x4a, 0x5d, 0xe4,
	0x85, 0x04, 0xfa, 0x9d, 0x1b, 0xb6, 0xc7, 0xac,
	0x25, 0x2e, 0x72, 0xc2, 0x02, 0xfd, 0xce, 0x0d,
	0x5b, 0xe3, 0xd6, 0x12, 0x17, 0xb9, 0x61, 0x81,
	0xfe, 0x67, 0x86, 0xad, 0x71, 0x6b, 0x89, 0x0b
};

static uint8_t test_iv[16] = {
	0xbe, 0x32, 0x97, 0x13, 0x43, 0xfc, 0x9a, 0x48,
	0xa0, 0x2a, 0x88, 0x5f, 0x19, 0x4b, 0x09, 0xa1
};

#ifndef AF_ALG
	#define AF_ALG 38
#endif
#ifndef SOL_ALG
	#define SOL_ALG 279
#endif

static int crypt_(int sd, uint8_t *out, uint8_t *in, unsigned int nbytes,
		 uint8_t *iv, unsigned int ivlen, uint32_t action)
{
	struct msghdr msgh = {};
	struct cmsghdr *cmsg;
	struct iovec iov;
	struct af_alg_iv *aiv;
	uint8_t msgbuf[512] = {};

	msgh.msg_control = msgbuf;
	msgh.msg_controllen = CMSG_SPACE(4);
	if (ivlen)
		msgh.msg_controllen += CMSG_SPACE(ivlen + 4);

	cmsg = CMSG_FIRSTHDR(&msgh);
	cmsg->cmsg_level = SOL_ALG;
	cmsg->cmsg_type = ALG_SET_OP;
	cmsg->cmsg_len = CMSG_LEN(4);
	*(uint32_t *) CMSG_DATA(cmsg) = action;

	if (ivlen) {
		cmsg = CMSG_NXTHDR(&msgh, cmsg);
		cmsg->cmsg_level = SOL_ALG;
		cmsg->cmsg_type = ALG_SET_IV;
		cmsg->cmsg_len = CMSG_LEN(ivlen + 4);
		aiv = (void *) CMSG_DATA(cmsg);
		aiv->ivlen = ivlen;
		memcpy(aiv->iv, test_iv, ivlen);
	}

	iov.iov_base = in;
	iov.iov_len = nbytes;
	msgh.msg_iov = &iov;
	msgh.msg_iovlen = 1;

	if (sendmsg(sd, &msgh, 0) == -1)
		return errno;

	if (read(sd, out, nbytes) == -1)
		return errno;

	return 0;
}

static int crypt_and_verify(int sd, uint8_t *out, uint8_t *in,
			    uint8_t *expected, unsigned int nbytes, uint8_t *iv,
			    unsigned int ivlen, uint32_t action)
{
	int i, ret;

	if ((ret = crypt_(sd, out, in, nbytes, iv, ivlen, action)) != 0)
		return ret;
		
	for (i = 0; i < nbytes; i++)
		if (out[i] != expected[i])
			return -2;

	return 0;
}

static int test_cipher(const char *algname, uint8_t *expected, uint8_t *iv,
		       unsigned int ivlen)
{
	struct sockaddr_alg sa = {
		.salg_family = AF_ALG,
		.salg_type   = "skcipher",
	};
	int sd[2] = {-1, -1};
	int ret = -1;
	uint8_t encbuf[512] = {};
	uint8_t decbuf[512] = {};

	strcpy(sa.salg_name, algname);
	fprintf(stdout, "testing %s...", algname);
	fflush(stdout);

	if ((sd[0] = socket(AF_ALG, SOCK_SEQPACKET, 0)) == -1)
		goto out;

	if (bind(sd[0], (struct sockaddr *) &sa, sizeof(sa)) != 0)
		goto close_sd0;

	/* Set key */
	setsockopt(sd[0], SOL_ALG, ALG_SET_KEY, test_key, sizeof(test_key));
	if ((sd[1] = accept(sd[0], NULL, 0)) == -1)
		goto close_sd0;

	/* Test encryption */
	if ((ret = crypt_and_verify(sd[1], encbuf, test_pt, expected,
		sizeof(test_pt), iv, ivlen, ALG_OP_ENCRYPT)) != 0)
		goto close_sd1;

	/* Test decryption */
	if ((ret = crypt_and_verify(sd[1], decbuf, encbuf, test_pt,
		sizeof(test_pt), iv, ivlen, ALG_OP_DECRYPT)) != 0)
		goto close_sd1;

close_sd1:
	close(sd[1]);
close_sd0:
	close(sd[0]);
out:
	fprintf(stdout, (ret == 0)
		? "ok\n" : "\x1b[31mfailed\x1b[0m\n");
	return ret;
}

void time_test()
{
	uint16_t i = 1;
	uint8_t belt_ecb_ct[48] = {
		0x69, 0xcc, 0xa1, 0xc9, 0x35, 0x57, 0xc9, 0xe3,
		0xd6, 0x6b, 0xc3, 0xe0, 0xfa, 0x88, 0xfa, 0x6e,
		0x5f, 0x23, 0x10, 0x2e, 0xf1, 0x09, 0x71, 0x07,
		0x75, 0x01, 0x7f, 0x73, 0x80, 0x6d, 0xa9, 0xdc,
		0x46, 0xfb, 0x2e, 0xd2, 0xce, 0x77, 0x1f, 0x26,
		0xdc, 0xb5, 0xe5, 0xd1, 0x56, 0x9f, 0x9a, 0xb0
	};
	while (i != 0)
	{
		if (test_cipher("ecb(belt)", belt_ecb_ct, NULL, 0) != 0)
			break;
		i ++;
	}
	fprintf(stdout, (i == 0)
		? "\n\x1b[32mTime test has passed.\x1b[0m\n"
		: "\n\x1b[31mThere is failure!\x1b[0m\n");
	
}

int main(int argc, const char *argv)
{
	int ret = 0;
	uint8_t belt_ecb_ct[48] = {
		0x69, 0xcc, 0xa1, 0xc9, 0x35, 0x57, 0xc9, 0xe3,
		0xd6, 0x6b, 0xc3, 0xe0, 0xfa, 0x88, 0xfa, 0x6e,
		0x5f, 0x23, 0x10, 0x2e, 0xf1, 0x09, 0x71, 0x07,
		0x75, 0x01, 0x7f, 0x73, 0x80, 0x6d, 0xa9, 0xdc,
		0x46, 0xfb, 0x2e, 0xd2, 0xce, 0x77, 0x1f, 0x26,
		0xdc, 0xb5, 0xe5, 0xd1, 0x56, 0x9f, 0x9a, 0xb0
	};


	if ((ret = test_cipher("ecb(belt)", belt_ecb_ct, NULL, 0)) != 0)
		goto out;

	/**********************************************************************/

	uint8_t belt_cbc_ct[48] = {
		0x10, 0x11, 0x6e, 0xfa, 0xe6, 0xad, 0x58, 0xee,
		0x14, 0x85, 0x2e, 0x11, 0xda, 0x1b, 0x8a, 0x74,
		0x5c, 0xf2, 0x48, 0x0e, 0x8d, 0x03, 0xf1, 0xc1,
		0x94, 0x92, 0xe5, 0x3e, 0xd3, 0xa7, 0x0f, 0x60,
		0x65, 0x7c, 0x1e, 0xe8, 0xc0, 0xe0, 0xae, 0x5b,
		0x58, 0x38, 0x8b, 0xf8, 0xa6, 0x8e, 0x33, 0x09
	};


	if ((ret = test_cipher("cbc(belt)", belt_cbc_ct, test_iv, 16)) != 0)
		goto out;

	/**********************************************************************/
	
	/**********************************************************************/

	uint8_t belt_cfb_ct[48] = {
		0xc3, 0x1e, 0x49, 0x0a, 0x90, 0xef, 0xa3, 0x74,
		0x62, 0x6c, 0xc9, 0x9e, 0x4b, 0x7b, 0x85, 0x40,
		0xa6, 0xe4, 0x86, 0x85, 0x46, 0x4a, 0x5a, 0x06,
		0x84, 0x9c, 0x9c, 0xa7, 0x69, 0xa1, 0xb0, 0xae,
		0x55, 0xc2, 0xcc, 0x59, 0x39, 0x30, 0x3e, 0xc8,
		0x32, 0xdd, 0x2f, 0xe1, 0x6c, 0x8e, 0x5a, 0x1b
	};


	if ((ret = test_cipher("cfb(belt)", belt_cfb_ct, test_iv, 16)) != 0)
		goto out;

	/**********************************************************************/
	
	/**********************************************************************/
/*
	uint8_t belt_ctr_ct[48] = {
		0x52, 0xc9, 0xaf, 0x96, 0xff, 0x50, 0xf6, 0x44,
		0x35, 0xfc, 0x43, 0xde, 0xf5, 0x6b, 0xd7, 0x97,
		0xd5, 0xb5, 0xb1, 0xff, 0x79, 0xfb, 0x41, 0x25,
		0x7a, 0xb9, 0xcd, 0xf6, 0xe6, 0x3e, 0x81, 0xf8,
		0xf0, 0x03, 0x41, 0x47, 0x3e, 0xae, 0x40, 0x98,
		0x33, 0x62, 0x2d, 0xe0, 0x52, 0x13, 0x77, 0x3a
	};


	if ((ret = test_cipher("ctr(belt)", belt_ctr_ct, test_iv, 16)) != 0)
		goto out;
*/
	/**********************************************************************/
	test();
	

out:
	fprintf(stdout, (ret == 0)
		? "\n\x1b[32mAll tests have passed.\x1b[0m\n"
		: "\n\x1b[31mThere are failures!\x1b[0m\n");

	return ret;
}
